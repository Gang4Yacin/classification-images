name: Image Similarity Comparison

on:
  workflow_dispatch:
    inputs:
      user_data:
        description: 'JSON list of users with images to compare'
        required: true
        type: string
      resumeUrl:
        description: 'n8n resume URL (automatically added by n8n)'
        required: false
        type: string

jobs:
  compare-images:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Run image similarity comparison
        id: compare
        env:
          USER_DATA: ${{ github.event.inputs.user_data }}
        run: |
          # Use an environment variable to avoid shell injection and quoting issues
          echo "$USER_DATA" > input.json
          python compare_images.py "$(cat input.json)" > results.json
          
          # Show results in the logs
          cat results.json
          
          # Set output (note: GitHub Action outputs have size limits, 
          # so we also save to a file/artifact if needed)
          echo "results=$(cat results.json | jq -c .)" >> $GITHUB_OUTPUT

      - name: Upload results as artifact
        uses: actions/upload-artifact@v4
        with:
          name: similarity-results
          path: results.json
